document.addEventListener("DOMContentLoaded",()=>{const d=new bootstrap.Modal(document.getElementById("question-modal")),r=document.getElementById("question-form"),l=document.getElementById("type"),E=document.getElementById("options-container"),q=document.getElementById("correct-answer-container"),a=document.getElementById("options-list"),y=document.getElementById("add-option"),u=document.getElementById("quiz-container").dataset.quizId,p=document.querySelector('meta[name="csrf-token"]').content;l.addEventListener("change",function(){const t=this.value==="multiple_choice";E.style.display=t?"block":"none",q.style.display=t?"block":"none",t||(a.innerHTML="")}),y.addEventListener("click",()=>{const t=document.createElement("div");t.className="input-group mb-2",t.innerHTML=`
            <input type="text" class="form-control" name="options[]" placeholder="Option text" required>
            <button class="btn btn-danger" type="button" onclick="this.parentElement.remove()">Remove</button>
        `,a.appendChild(t)}),document.getElementById("open-add-question-modal").addEventListener("click",()=>{r.reset(),r.dataset.id="",a.innerHTML="",l.dispatchEvent(new Event("change")),d.show()}),document.querySelectorAll(".edit-question").forEach(t=>{t.addEventListener("click",c=>{const o=c.target.dataset;if(r.reset(),r.dataset.id=o.id,r.querySelector("#question_text").value=o.question,r.querySelector("#type").value=o.type,r.querySelector("#points").value=o.points,l.dispatchEvent(new Event("change")),o.type==="multiple_choice"){const i=JSON.parse(o.options||"[]");a.innerHTML="",i.forEach(n=>{const e=document.createElement("div");e.className="input-group mb-2",e.innerHTML=`
                        <input type="text" class="form-control" name="options[]" value="${n}" required>
                        <button class="btn btn-danger" type="button" onclick="this.parentElement.remove()">Remove</button>
                    `,a.appendChild(e)}),r.querySelector("#correct_answer").value=o.correct||""}d.show()})}),document.getElementById("save-question").addEventListener("click",()=>{const t=new FormData(r),c=r.dataset.id;t.append("quiz_id",u);let o=`/dev/corpu2/simapeka/public/quizzes/${u}/questions`,i="POST";c&&(o=`/dev/corpu2/simapeka/public/questions/${c}`,i="PUT");const n={};if(t.forEach((e,s)=>{s==="options[]"?(n.options||(n.options=[]),n.options.push(e)):n[s]=e}),!n.question_text||!n.type||!n.points){alert("Please fill in all required fields.");return}if(n.type==="multiple_choice"&&(!n.options||n.options.length===0)){alert("Please add at least one option for multiple choice questions.");return}fetch(o,{method:i,body:JSON.stringify(n),headers:{"X-CSRF-TOKEN":p,Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.ok?e.json():e.json().then(s=>{throw new Error(JSON.stringify(s))})).then(e=>{e.success?location.reload():alert(e.message||"Error saving question")}).catch(e=>{console.error("Error:",e);try{const s=JSON.parse(e.message);let m=`Validation errors:
`;for(let h in s.errors)m+=`${h}: ${s.errors[h].join(", ")}
`;alert(m)}catch{alert("An error occurred while saving the question. Check the console for more details.")}})}),document.querySelectorAll(".delete-question").forEach(t=>{t.addEventListener("click",c=>{const o=c.target.dataset.id;confirm("Are you sure you want to delete this question?")&&fetch(`/dev/corpu2/simapeka/public/questions/${o}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":p}}).then(i=>i.json()).then(i=>{i.success?location.reload():alert(i.message||"Error deleting question")}).catch(i=>{console.error("Error:",i),alert("An error occurred while deleting the question.")})})})});
